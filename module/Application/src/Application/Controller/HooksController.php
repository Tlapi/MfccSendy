<?php
/**
 * Zend Framework (http://framework.zend.com/)
 *
 * @link      http://github.com/zendframework/ZendSkeletonApplication for the canonical source repository
 * @copyright Copyright (c) 2005-2013 Zend Technologies USA Inc. (http://www.zend.com)
 * @license   http://framework.zend.com/license/new-bsd New BSD License
 */

namespace Application\Controller;

use Zend\Mvc\Controller\AbstractActionController;
use Zend\View\Model\ViewModel;

class HooksController extends AbstractActionController
{

	/**
	 * @var Doctrine\ORM\EntityManager
	 */
	protected $em;

    public function indexAction()
    {

    	$writer = new \Zend\Log\Writer\Stream('log/hooks.txt');
    	$logger = new \Zend\Log\Logger();
    	$logger->addWriter($writer);

    	//$_POST['mandrill_events']='[{"event":"click","url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ts":1386588716,"user_agent":"Mozilla\/5.0 (Windows NT 5.1; rv:25.0) Gecko\/20100101 Firefox\/25.0","user_agent_parsed":{"type":"Browser","ua_family":"Firefox","ua_name":"Firefox 25.0","ua_version":"25.0","ua_url":"http:\/\/www.firefox.com\/","ua_company":"Mozilla Foundation","ua_company_url":"http:\/\/www.mozilla.org\/","ua_icon":"http:\/\/cdn.mandrill.com\/img\/email-client-icons\/firefox.png","os_family":"Windows","os_name":"Windows XP","os_url":"http:\/\/en.wikipedia.org\/wiki\/Windows_XP","os_company":"Microsoft Corporation.","os_company_url":"http:\/\/www.microsoft.com\/","os_icon":"http:\/\/cdn.mandrill.com\/img\/email-client-icons\/windowsxp.png","mobile":false},"ip":"85.71.13.129","location":{"country_short":"CZ","country":"Czech Republic","region":"Hlavni Mesto Praha","city":"Prague","latitude":50.0880393982,"longitude":14.4207601547,"postal_code":"-","timezone":"+02:00"},"_id":"953081a1dfe54b319a5a14c63faa0f71","msg":{"ts":1385988327,"_id":"953081a1dfe54b319a5a14c63faa0f71","state":"sent","subject":"Sleduj, jak v praxi funguje vylad\u011bn\u00fd automat na v\u00fdkup lahv\u00ed","email":"ALENAVLADIMIR@seznam.cz","tags":["machinegun"],"opens":[{"ts":1385997324,"ip":"85.119.89.47","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0","location":"Liberecky Kraj, CZ"},{"ts":1385997321,"ip":"85.119.89.47","location":"Liberecky Kraj, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386009576,"ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386009606,"ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386009607,"ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386010836,"ip":"90.180.111.65","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386009597,"ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386009611,"ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386009304,"ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386019184,"ip":"88.102.10.243","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 7.0"},{"ts":1386019184,"ip":"88.102.10.243","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 7.0"},{"ts":1386051852,"ip":"90.176.238.169","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 7.0"},{"ts":1386055457,"ip":"77.78.89.194","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386060073,"ip":"85.70.20.188","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Outlook 2007\/Outlook 2007"},{"ts":1386069183,"ip":"77.78.89.197","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 7.0"},{"ts":1386070122,"ip":"31.41.203.193","location":"Liberecky Kraj, CZ","ua":"Windows\/Windows 7\/IE\/IE 7.0"},{"ts":1386075046,"ip":"88.101.90.120","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386073962,"ip":"188.122.192.131","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows 7\/IE\/IE 9.0"},{"ts":1386086416,"ip":"78.102.243.184","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/IE\/IE 7.0"},{"ts":1386090717,"ip":"84.42.208.90","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386092949,"ip":"178.248.252.184","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386097129,"ip":"37.48.33.119","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386087549,"ip":"37.188.224.249","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 7.0"},{"ts":1386091009,"ip":"195.22.50.136","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386090892,"ip":"84.42.208.90","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"}],"clicks":[{"ts":1385997324,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"85.119.89.47","location":"Liberecky Kraj, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386009323,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"85.70.190.167","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386010850,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"90.180.111.65","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386011421,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"194.228.20.69","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386015488,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.144.195.252","location":"Wien, AT","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386017797,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.77.238.232","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386017651,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"83.208.227.164","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows Vista\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386018436,"url":"http:\/\/machinegun.mfcc.cz\/public\/unsubscribe\/29401\/59","ip":"88.102.10.243","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386018476,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.102.10.243","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386053762,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.11","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386055465,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"77.78.89.194","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386060083,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"85.70.20.188","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386060382,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"85.70.169.86","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386066331,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.103.99.197","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386069191,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"77.78.89.197","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386073996,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"188.122.192.131","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows 7\/IE\/IE 9.0"},{"ts":1386073958,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"188.122.192.131","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows 7\/IE\/IE 9.0"},{"ts":1386074234,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.248.248.147","location":"Pardubicky Kraj, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386074529,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.11","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386075059,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.101.90.120","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386077322,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"85.119.88.155","location":"Liberecky Kraj, CZ","ua":"Windows\/Windows Vista\/Firefox\/Firefox 25.0"},{"ts":1386086262,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"78.102.243.184","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386087264,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.11","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386088548,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.11","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386090720,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"84.42.208.90","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386091043,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"195.22.50.136","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386094716,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.29.101.78","location":"Moravskoslezsky Kraj, CZ","ua":"Windows\/Windows 8\/Firefox\/Firefox 25.0"},{"ts":1386096965,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"109.80.7.42","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386087569,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.188.224.249","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386092962,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"178.248.252.184","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386097178,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.48.33.119","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386097212,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.48.33.119","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386098758,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.102.45.93","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 8\/IE\/IE 10.0"},{"ts":1386107461,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.100.180.207","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386146271,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"172.20.128.231","location":null,"ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386146906,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.13.174.20","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386146880,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"172.20.128.210","location":null,"ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386147211,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.13.174.20","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386147968,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"84.42.208.90","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386148476,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.13.220.12","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 4.0"},{"ts":1386148758,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.16.120.91","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386150960,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.16.120.91","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386151403,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.16.120.91","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386153890,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"185.7.47.101","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386153841,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"185.7.47.101","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386155620,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"90.177.245.82","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386155778,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"78.102.227.75","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Opera\/Opera 12.16"},{"ts":1386156386,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"185.7.47.122","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows XP\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386159136,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"78.102.227.75","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386159476,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"90.180.158.205","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386160537,"url":"http:\/\/machinegun.mfcc.cz\/public\/unsubscribe\/29401\/59","ip":"192.168.30.26","location":null,"ua":"Windows\/Windows 7\/IE\/IE 9.0"},{"ts":1386161567,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"194.228.155.226","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows\/Mozilla\/Mozilla rv:11.0"},{"ts":1386162073,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"62.201.22.8","location":"Liberecky Kraj, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386163389,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"188.75.144.50","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386164333,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.11","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386164372,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"94.112.161.116","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386165013,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"83.240.61.23","location":"Jihomoravsky Kraj, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386165074,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"94.112.161.116","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386172872,"url":"http:\/\/www.pardal.cz?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.9","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386172931,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.9","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386172893,"url":"http:\/\/www.pardal.cz\/eshop?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.9","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386173570,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"178.209.130.129","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386174166,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"172.218.8.45","location":"British Columbia, CA","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386179603,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"90.181.117.108","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386183205,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"78.102.196.114","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386183254,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"78.102.196.114","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386183224,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"78.102.196.114","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386172903,"url":"https:\/\/www.facebook.com\/pardal.cz?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.9","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386186741,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"66.183.105.139","location":"British Columbia, CA","ua":"Windows\/Windows Vista\/IE\/IE 9.0"},{"ts":1386191014,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"77.78.89.198","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386191162,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"46.135.95.1","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386198976,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"195.191.202.19","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Opera\/Opera 12.16"},{"ts":1386203621,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"94.199.40.193","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386204091,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"94.199.40.193","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386214766,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"66.183.247.71","location":"British Columbia, CA","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386214825,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"66.183.247.71","location":"British Columbia, CA","ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386220489,"url":"http:\/\/www.pardal.cz?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"77.78.89.139","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows Vista\/IE\/IE 9.0"},{"ts":1386223871,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.103.23.73","location":"Hlavni Mesto Praha, CZ","ua":"Mobile\/Android\/Android 4.1.x Jelly Bean\/Android Webkit\/Android Webkit 4.0"},{"ts":1386223855,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.103.23.73","location":"Hlavni Mesto Praha, CZ","ua":"Mobile\/Android\/Android 4.1.x Jelly Bean\/Android Webkit\/Android Webkit 4.0"},{"ts":1386224509,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"10.205.136.238","location":null,"ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386224516,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"10.205.136.238","location":null,"ua":"Windows\/Windows XP\/IE\/IE 8.0"},{"ts":1386225461,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"77.236.195.46","location":"Pardubicky Kraj, CZ","ua":"Windows\/Windows XP\/Opera\/Opera 12.16"},{"ts":1386231675,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.203.185.102","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.57"},{"ts":1386232673,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"77.78.89.130","location":"Hlavni Mesto Praha, CZ","ua":"Linux\/Linux (Ubuntu)\/Chromium\/Chromium 18.0.1025.151"},{"ts":1386234551,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.48.46.22","location":"Hlavni Mesto Praha, CZ","ua":"Mobile\/Android\/Android 4.1.x Jelly Bean\/Android Webkit\/Android Webkit 4.0"},{"ts":1386234552,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.48.46.22","location":"Hlavni Mesto Praha, CZ","ua":"Mobile\/Android\/Android 4.1.x Jelly Bean\/Android Webkit\/Android Webkit 4.0"},{"ts":1386234582,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"37.48.46.22","location":"Hlavni Mesto Praha, CZ","ua":"Mobile\/Android\/Android 4.1.x Jelly Bean\/Android Webkit\/Android Webkit 4.0"},{"ts":1386240061,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.203.185.102","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386241743,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"195.191.202.22","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 25.0"},{"ts":1386243007,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.103.84.119","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386243772,"url":"http:\/\/www.pardal.cz?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"213.192.59.2","location":"Stredocesky Kraj, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386246763,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.190.94.194","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386246938,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"195.191.202.21","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386247446,"url":"http:\/\/machinegun.mfcc.cz\/public\/unsubscribe\/29401\/59","ip":"92.104.3.67","location":"Zurich, CH","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386248343,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.103.84.119","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows XP\/Firefox\/Firefox 25.0"},{"ts":1386249994,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"88.101.42.108","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386250467,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"89.190.68.5","location":"Kralovehradecky Kraj, CZ","ua":"Windows\/Windows 7\/Firefox\/Firefox 23.0"},{"ts":1386251065,"url":"http:\/\/www.pardal.cz\/mailing\/2013-11-automat-internal-web.html?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"90.178.91.33","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/IE\/IE 10.0"},{"ts":1386250985,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"195.191.202.19","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Mozilla\/Mozilla rv:11.0"},{"ts":1386251717,"url":"https:\/\/www.youtube.com\/watch?v=usmWhP8wTDI?utm_source=pardal-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-11-automat","ip":"93.89.144.1","location":"Kralovehradecky Kraj, CZ","ua":"Mobile\/Android\/Android 4.1.x Jelly Bean\/Android Webkit\/Android Webkit 4.0"}],"smtp_events":[{"ts":1385990258,"type":"sent","diag":"250 2.0.0 Mail 934801897 queued for delivery in session 78f20000032b.","source_ip":"198.2.128.10","destination_ip":"77.75.76.42","size":11145}],"resends":[],"_version":"iYz_yq6kBPb5g4T_6G2AOw","_table":"Search","metadata":{"campaignId":59,"brandId":3},"sender":"noreply@pardal.cz","template":"id-59"}},{"event":"click","url":"http:\/\/shop.budvar.cz?utm_source=budvar-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-12-vanoce","ts":1386589129,"user_agent":"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/31.0.1650.63 Safari\/537.36","user_agent_parsed":{"type":"Browser","ua_family":"Chrome","ua_name":"Chrome 31.0.1650.63","ua_version":"31.0.1650.63","ua_url":"http:\/\/www.google.com\/chrome","ua_company":"Google Inc.","ua_company_url":"http:\/\/www.google.com\/","ua_icon":"http:\/\/cdn.mandrill.com\/img\/email-client-icons\/chrome.png","os_family":"Windows","os_name":"Windows 7","os_url":"http:\/\/en.wikipedia.org\/wiki\/Windows_7","os_company":"Microsoft Corporation.","os_company_url":"http:\/\/www.microsoft.com\/","os_icon":"http:\/\/cdn.mandrill.com\/img\/email-client-icons\/windows-7.png","mobile":false},"ip":"195.250.142.198","location":{"country_short":"CZ","country":"Czech Republic","region":"Hlavni Mesto Praha","city":"Prague","latitude":50.0880393982,"longitude":14.4207601547,"postal_code":"-","timezone":"+02:00"},"_id":"79e5a4869ca34651be438d8c881447b2","msg":{"ts":1386589104,"_id":"79e5a4869ca34651be438d8c881447b2","state":"sent","subject":"Nav\u0161tivte e-shop Budweiser Budvar a p\u0159ekvapte sv\u00e9 bl\u00edzk\u00e9","email":"jan.sourek@mfcc.cz","tags":["machinegun"],"opens":[{"ts":1386589125,"ip":"195.250.142.198","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.63","location":"Hlavni Mesto Praha, CZ"}],"clicks":[{"ts":1386589125,"url":"http:\/\/shop.budvar.cz\/katalog\/produkt\/softshellova-panska-bunda\/149?utm_source=budvar-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-12-vanoce","ip":"195.250.142.198","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.63"},{"ts":1386589129,"url":"http:\/\/shop.budvar.cz?utm_source=budvar-mailing-internal&utm_medium=email&utm_content=viaemail&utm_campaign=2013-12-vanoce","ip":"195.250.142.198","location":"Hlavni Mesto Praha, CZ","ua":"Windows\/Windows 7\/Chrome\/Chrome 31.0.1650.63"}],"smtp_events":[],"resends":[],"_version":"juhGj5dt1ABbqtTW3vibRw","_table":"Search","metadata":{"campaignId":60,"brandId":2},"sender":"noreply@budvar.cz","template":"id-60"}}]';
    	
    	$mandrillWebhookData = json_decode($_POST['mandrill_events']);

    	
    	$logger->info('CALLED: '.$_POST['mandrill_events']);

    	$pubnub = $this->getServiceLocator()->get('pubnubService');

    	$campaigns = $this->getEntityManager()->getRepository('Application\Entity\Campaign');
    	$campaignTests = $this->getEntityManager()->getRepository('Application\Entity\CampaignTests');
    	$subscribers = $this->getEntityManager()->getRepository('Application\Entity\Subscriber');

    	$metadataTest = \Application\Service\CampaignSender::METADATA_MESSAGE_TEST;
    	
    	// Parse Mandrill Webhook events
    	if(sizeof($mandrillWebhookData)) foreach ($mandrillWebhookData as $event){
    		$logger->info($event->msg->email.' | '.$event->event.' | '.join('-',$event->msg->tags).' | '.json_encode($event->msg->metadata));
						
    		if(isset($event->msg->email)){

	    		if(in_array(\Application\Service\CampaignSender::MESSAGE_TEST_TAG, $event->msg->tags) || isset($event->msg->metadata->$metadataTest)){
	    			$id = $event->msg->_id;
	    			// Test message
	    			if($event->event=='open'){
	    				$testMail = $campaignTests->findOneBy(array('mandrill_id' => $id));
	    				if($testMail){
	    					$testMail->opened = new \DateTime(date('Y-m-d H:i:s', $event->ts));
	    					$this->getEntityManager()->persist($testMail);
	    				}
	    			}
	    			if($event->event=='click'){
	    				$testMail = $campaignTests->findOneBy(array('mandrill_id' => $id));
	    				if($testMail){
	    					$testMail->clicked = new \DateTime(date('Y-m-d H:i:s', $event->ts));
	    					$this->getEntityManager()->persist($testMail);
	    				}
	    			}

	    			// Live feed
	    			$info = $pubnub->publish(array(
	    					'channel' => 'mfcc_sender_test_event', ## REQUIRED Channel to Send
	    					'message' => json_encode(array(
	    							'email' => $event->msg->email,
	    							'ts' => $event->ts,
	    							'event' => $event->event
	    					))
	    			));
	    		} else {
	    			// Production message

	    			$campaignId = $this->getCampaignIdFromTags($event->msg->tags); // deprecated
	    			
	    			if(isset($event->msg->metadata->campaignId)){ // actual
	    				$campaignId = $event->msg->metadata->campaignId;
	    				
	    			}
	    				    			
	    			if($campaignId)
	    				$campaign = $campaigns->find($campaignId);
	    			
	    			$subscriber = $subscribers->findOneBy(array('email' => $event->msg->email));

	    			if($campaign && $subscriber){
		    			// Log event to db
		    			$logRow = new \Application\Entity\CampaignLog();
		    			$logRow->event = $event->event;
		    			$logRow->email = $event->msg->email;
		    			//$logRow->subscriber = $subscriber;
		    			$logRow->msg = $event->msg->bounce_description;
		    			$logRow->campaign = $campaign;

		    			if($event->event=='open'){
		    				// User Agent
		    				$ua = $campaign->ua;
		    				if(isset($ua[$event->user_agent_parsed->ua_family][$event->user_agent_parsed->ua_version]))
		    					$ua[$event->user_agent_parsed->ua_family][$event->user_agent_parsed->ua_version]++;
		    				else
		    					$ua[$event->user_agent_parsed->ua_family][$event->user_agent_parsed->ua_version] = 1;
		    				$campaign->ua = $ua;

		    				// OS
		    				$os = $campaign->os;
		    				if(isset($os[$event->user_agent_parsed->os_family][$event->user_agent_parsed->os_name]))
		    					$os[$event->user_agent_parsed->os_family][$event->user_agent_parsed->os_name]++;
		    				else
		    					$os[$event->user_agent_parsed->os_family][$event->user_agent_parsed->os_name] = 1;
		    				$campaign->os = $os;

		    				// Location
		    				// TODO handle city
		    				$location = $campaign->location;
		    				if(isset($location[$event->location->country][$event->location->region]))
		    					$location[$event->location->country][$event->location->region]++;
		    				else
		    					$location[$event->location->country][$event->location->region] = 1;
		    				$campaign->location = $location;

		    				$this->getEntityManager()->persist($campaign);
		    			}
		    			
		    			// Click event
		    			if($event->event=='click'){
		    				$logRow->msg = $event->url;
		    			}
		    			
		    			// Hard bounce event
		    			if($event->event=='hard_bounce'){
		    				$subscriber->bounced_hard = 1;
		    				$subscriber->bounce_message = $event->msg->bounce_description;
		    				$this->getEntityManager()->persist($subscriber);
		    			}
		    			
		    			// Soft bounce event
		    			if($event->event=='soft_bounce'){
		    				$subscriber->bounce_soft = 1;
		    				$subscriber->bounce_message = $event->msg->bounce_description;
		    				$this->getEntityManager()->persist($subscriber);
		    			}

		    			$this->getEntityManager()->persist($logRow);

		    			// Live feed
		    			$info = $pubnub->publish(array(
		    					'channel' => 'mfcc_sender_event', ## REQUIRED Channel to Send
		    					'message' => json_encode(array(
		    							'email' => $event->msg->email,
		    							'ts' => $event->ts,
		    							'latitude' => $event->location->latitude,
		    							'longitude' => $event->location->longitude,
		    							'event' => $event->event
		    					))
		    			));
	    			}
	    		}

    		}
    	}

    	$this->getEntityManager()->flush();

    	die('hook');

        return new ViewModel(array(

        ));
    }

    public function setAction()
    {
    	// TODO move to factory
    	$webhooks = $this->getServiceLocator()->get('webhooks');

    	$webhooks->addWebhook();

		$this->redirect()->toRoute('home');
    }

    /**
     * Get Campaign ID from Mandrill tags
     */
    public function getCampaignIdFromTags($tags = array())
    {
    	foreach($tags as $tag){
    		if (strpos($tag, \Application\Service\CampaignSender::CAMPAIGN_TAG_PREFIX) !== false) {
    			return str_replace(\Application\Service\CampaignSender::CAMPAIGN_TAG_PREFIX, '', $tag);
    		}
    	}
    }

    public function setEntityManager(EntityManager $em)
    {
    	$this->em = $em;
    }
    public function getEntityManager()
    {
    	if (null === $this->em) {
    		$this->em = $this->getServiceLocator()->get('Doctrine\ORM\EntityManager');
    	}
    	return $this->em;
    }
}
